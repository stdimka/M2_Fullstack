# CTE (Common Table Expression)

**CTE (ÐžÐ±Ñ‰ÐµÐµ Ñ‚Ð°Ð±Ð»Ð¸Ñ‡Ð½Ð¾Ðµ Ð²Ñ‹Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ)** â€” ÑÑ‚Ð¾ Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¼ SQL-Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ.

CTE ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ÑÑ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ ÐºÐ»ÑŽÑ‡ÐµÐ²Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð° `WITH` Ð¸ Ñ‡Ð°ÑÑ‚Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ð¾ÑÑ‚Ð¸, Ð´Ð»Ñ Ñ€ÐµÐºÑƒÑ€ÑÐ¸Ð²Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¸ Ð´Ð»Ñ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð»Ð¾Ð³Ð¸ÐºÐ¸.

## âœ… Ð¡Ð¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ
```
WITH Ð¸Ð¼Ñ_cte (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ_Ð¿Ð¾Ð»Ñ) AS (
    Ð¿Ð¾Ð´Ð·Ð°Ð¿Ñ€Ð¾Ñ
)
SELECT ...
FROM Ð¸Ð¼Ñ_cte;
```

## ðŸ“Œ ÐŸÑ€Ð¸Ð¼ÐµÑ€ CTE

```
WITH recent_orders AS (
    SELECT *
    FROM orders
    WHERE order_date >= '2024-01-01'
)
SELECT customer_id, COUNT(*) AS order_count
FROM recent_orders
GROUP BY customer_id;
```
Ð—Ð´ÐµÑÑŒ `recent_orders` â€” ÑÑ‚Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ "Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°", ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°.

## ÐŸÑ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð° Ð¸ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ¸ CTE

| ÐŸÑ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð¾           | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ |
|------------------------|----------|
| Ð£Ð»ÑƒÑ‡ÑˆÐ°ÐµÑ‚ Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ð¾ÑÑ‚ÑŒ    | ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ Ð´Ð»Ñ Ð²Ð»Ð¾Ð¶ÐµÐ½Ð½Ñ‹Ñ… Ð¸ Ð¼Ð½Ð¾Ð³Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½Ñ‡Ð°Ñ‚Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² |
| ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ | ÐžÐ´Ð¸Ð½ Ð¸ Ñ‚Ð¾Ñ‚ Ð¶Ðµ Ð¿Ð¾Ð´Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ñ€Ð°Ð· |
| ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ñ€ÐµÐºÑƒÑ€ÑÐ¸ÑŽ     | ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° `WITH RECURSIVE` Ð´Ð»Ñ Ð¸ÐµÑ€Ð°Ñ€Ñ…Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… |
| ÐœÐ¾Ð´ÑƒÐ»ÑÑ€Ð½Ð¾ÑÑ‚ÑŒ           | Ð›ÐµÐ³ÐºÐ¾ Ñ€Ð°Ð·Ð±Ð¸Ñ‚ÑŒ ÑÐ»Ð¾Ð¶Ð½ÑƒÑŽ Ð»Ð¾Ð³Ð¸ÐºÑƒ Ð½Ð° Ñ‡Ð°ÑÑ‚Ð¸ |

| ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº               | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ |
|--------------------------|----------|
| ÐœÐ¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¼ÐµÐ½ÐµÐµ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¼ | Ð˜Ð½Ð¾Ð³Ð´Ð° Ñ…ÑƒÐ¶Ðµ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ÑÑ, Ñ‡ÐµÐ¼ Ð¿Ð¾Ð´Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð¸Ð»Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ |
| Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ | CTE Ð½ÐµÐ»ÑŒÐ·Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ â€” Ð¾Ð½Ð° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° |
| ÐÐµ Ð²ÑÐµÐ³Ð´Ð° Ð·Ð°Ð¼ÐµÐ½ÑÐµÑ‚ `JOIN` | Ð”Ð»Ñ Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð·Ð°Ð´Ð°Ñ‡ `JOIN` Ð´Ð°Ñ‘Ñ‚ Ð±Ð¾Ð»ÐµÐµ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ |

## Ð’Ð°Ð¶Ð½Ð¾Ðµ Ð´Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ!
Ð˜Ð¼ÐµÐ¹Ñ‚Ðµ Ð² Ð²Ð¸Ð´Ñƒ, Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ WITH Ð²ÑÐµÐ³Ð´Ð° Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð² Ð½ÐµÐ¹ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð½Ð¾ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ. 
ÐŸÐ¾ÑÑ‚Ð¾Ð¼Ñƒ Ð¸Ð·Ð²Ð»ÐµÐºÐ°Ñ‚ÑŒ ÑÑ‚Ð¾ ÐµÐ´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¸Ð· Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð¿Ñ€Ð¸Ð´Ñ‘Ñ‚ÑÑ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð¼:
```
WITH avg_price AS (
	SELECT AVG(unit_price) AS avg_p FROM order_details
)

SELECT
    unit_price
FROM
	order_details
WHERE unit_price > (SELECT avg_p FROM avg_price);
```